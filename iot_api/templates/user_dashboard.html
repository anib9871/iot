<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Multi-Level Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
body { margin:0; padding-top:70px; display:flex; }
.navbar { background: linear-gradient(90deg, #0d6efd, #0a58ca); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.navbar .nav-link { color:#fff !important; }
.sidebar { width:260px; background:#f8f9fa; border-right:1px solid #dee2e6; padding:20px; position:fixed; top:70px; bottom:0; display:flex; flex-direction:column; overflow:hidden; }
.sidebar-content { overflow-y:auto; flex:1; padding-right:5px; }
.sidebar h5 { font-weight:600; margin-bottom:15px; }
.sidebar .form-select { margin-bottom:15px; border-radius:8px; }
.sidebar .summary-card { min-height:60px; padding:2px 4px; margin-bottom:10px; font-size:0.8rem; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; color:#fff; }
.sidebar .summary-card i { font-size:1.4rem; margin-bottom:4px; }
.sidebar .summary-card h6 { font-size:0.85rem; margin-bottom:2px; }
.sidebar .summary-card p { font-size:0.9rem; margin:0; font-weight:600; }
.content { margin-left:260px; padding:20px; flex:1; overflow-x:hidden; }
#deviceTypeCards { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:50px; }
.device-type-card { flex:1 1 calc(33.33% - 10px); max-width:calc(33.33% - 10px); height:120px; background:linear-gradient(135deg,#0d6efd,#6610f2); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); cursor:pointer; transition:0.3s; }
.device-type-card:hover { transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.2); }
.device-type-card.disabled { background:#e0e0e0 !important; color:#888 !important; cursor:not-allowed; }
.device-card { padding:10px; border-radius:12px; color:white; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:10px; max-width:300px; width:100%; }
.device-card.bg-success { background:#fff; border:2px solid #28a745; color:#000; min-height:60px; max-width:400px; }
.device-card.bg-danger { background:#fff; border:2px solid #dc3545; color:#000; min-height:60px; max-width:400px; }
#deviceDetailsContainer { display:none; }
#deviceList .device-card { width:100%; margin-bottom:8px; }
#alarmLog tr td { vertical-align:middle; }

#deviceList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start;
  align-items: flex-start;
  margin-bottom: 20px;
}

#deviceList .device-card {
  flex: 1 1 200px; /* min width 200px, adjusts automatically */
  max-width: 250px;
  min-width: 180px;
}


</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
<div class="container-fluid">
  <a class="navbar-brand" href="#">IoT Dashboard</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
    </ul>
  </div>
</div>
</nav>

<div class="sidebar">
  <div class="sidebar-content">
    <h5>Filters</h5>
    <select id="organizationSelect" class="form-select mb-3"><option value="">Select Organization</option></select>
    <select id="centreSelect" class="form-select mb-3"><option value="">Select Centre</option></select>

    <label for="startDateTime">Start Date & Time</label>
    <input type="datetime-local" id="startDateTime" class="form-control mb-2">
    <label for="endDateTime">End Date & Time</label>
    <input type="datetime-local" id="endDateTime" class="form-control mb-3">
    <button class="btn btn-sm btn-warning w-100 mt-2 mb-3" onclick="clearFilters()">Clear Filters</button>
    <h5>Summary</h5>
    <div id="summaryCards">
      <div class="summary-card bg-primary text-center mb-3">
        <i class="bi bi-hdd-network"></i><h6>Total Devices</h6><p id="totalDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-success text-center mb-3">
        <i class="bi bi-check-circle"></i><h6>Active Devices</h6><p id="activeDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-danger text-center mb-3">
        <i class="bi bi-x-circle"></i><h6>Offline Devices</h6><p id="offlineDevices" class="fs-5 fw-bold">0</p>
      </div>
    </div>
  </div>
</div>

<div class="content">
  <div id="deviceTypeCards" class="d-flex flex-wrap gap-3"></div>

  <div id="deviceDetailsContainer">
    <button class="btn btn-sm btn-secondary mb-3" onclick="backToDashboard()">← Back</button>
    <h4 id="deviceTypeTitle"></h4>

    <div id="deviceList" class="mb-3"></div>         

    <div style="max-width:700px;margin:auto;display:flex;gap:15px;align-items:flex-start;">
      <div style="flex:0 0 150px;display:flex;flex-direction:column;gap:10px;margin-left:-200px;">
        <!-- <div style="background:#0d6efd;color:#fff;border-radius:10px;padding:8px;text-align:center;">
          <h6 style="font-size:0.8rem;margin-bottom:4px;">Current Temp</h6>
          <p id="currentTemp" class="fs-6 fw-bold">0 °C</p>
        </div> -->
            <div style="max-width:250px;background:#dc3545;color:#fff;border-radius:10px;padding:8px;text-align:center;" class="mb-3">
          <h6 style="font-size:0.8rem;margin-bottom:4px;">Total Alarms (24h)</h6>
          <p id="alarm24h" class="fs-6 fw-bold">0</p>
        </div>


      </div>
      <div style="flex:1;background:#fff;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);padding:15px;">
        <canvas id="deviceGraph" style="max-height:300px;"></canvas>
      </div>
    </div>

    <h5 class="mt-4 d-flex justify-content-between align-items-center">
      Alarm Log <span class="badge bg-danger" id="activeAlarmCount">0</span>
    </h5>
    <!-- <input type="text" id="alarmSe rch" class="form-control mb-2" placeholder="Search alarms..."> -->
    <table class="table table-striped">
      <thead><tr><th>Device</th><th>Alarm</th><th>Time</th><th>Status</th></tr></thead>
      <tbody id="alarmLog"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Base API
const BASE_URL = "https://iot-y8pi.onrender.com";
const API = {
  masterorganizations: BASE_URL + "/api/masterorganization/",
  mastercentre: BASE_URL + "/api/mastercentre/",
  devicecategory: BASE_URL + "/api/devicecategory/",
  masterDevices: BASE_URL + "/api/masterdevice/",
  devicereadinglog: BASE_URL + "/api/devicereadinglog/",
  devicealarmlog: BASE_URL + "/api/devicealarmlog/",
  userorganizationcentrelink: BASE_URL + "/api/userorganizationcentrelink/",
  masteruom:           BASE_URL + "/api/masteruom/",
  masterparameter:     BASE_URL + "/api/masterparameter/",
};

let centreData=[], allDevices=[], allCategories=[], currentCentreId=null, currentUser=null;
let currentCategoryId=null, liveUpdateInterval=null;

async function startLiveUpdates(categoryId){
    if(liveUpdateInterval) clearInterval(liveUpdateInterval);
    liveUpdateInterval = setInterval(() => openDeviceDashboard(categoryId, false), 10000);
}

// Load organizations dropdown
async function loadOrganizations(){
  try{
    const userRes = await fetch(BASE_URL + "/api/currentuser/");
    currentUser = await userRes.json();

    const linkRes = await fetch(API.userorganizationcentrelink + `?USER_ID=${currentUser.USER_ID}`);
    const userLinks = await linkRes.json();
    const allowedOrgIds = userLinks.map(l => l.ORGANIZATION_ID);

    const res = await fetch(API.masterorganizations);
    const orgs = await res.json();
    const orgSelect = document.getElementById("organizationSelect");
    orgSelect.innerHTML = '<option value="">Select Organization</option>';
    orgs.filter(o => allowedOrgIds.includes(o.ORGANIZATION_ID))
        .forEach(o => orgSelect.innerHTML += `<option value="${o.ORGANIZATION_ID}">${o.ORGANIZATION_NAME}</option>`);
    
    // Auto select user org
    if(userLinks.length>0){
      orgSelect.value = userLinks[0].ORGANIZATION_ID;
      await loadCentres(orgSelect.value, true, userLinks[0].CENTRE_ID);
    }
  }catch(err){ console.error(err);}
}

// Load centres dropdown
async function loadCentres(orgId, auto=false, userCentreId=null){
  const centreSelect = document.getElementById("centreSelect");
  centreSelect.innerHTML = '<option value="">Select Centre</option>';
  if(!orgId) return;

  try {
    if(!centreData.length){
      const res = await fetch(API.mastercentre);
      centreData = await res.json();
    }

    // Filter only user's allotted centre
    let filtered = centreData.filter(c => c.ORGANIZATION_ID == orgId);
    if(userCentreId) {
      filtered = filtered.filter(c => c.CENTRE_ID == userCentreId);
    }

    filtered.forEach(c => {
      centreSelect.innerHTML += `<option value="${c.CENTRE_ID}">${c.CENTRE_NAME}</option>`;
    });

    if(auto && userCentreId) {
      centreSelect.value = userCentreId;
      loadDevices(userCentreId);
    }
  } catch(err) {
    console.error(err);
  }
}

// Load devices & categories
async function loadDevices(centreId){
  currentCentreId=centreId;
  try{
    const res = await fetch(API.masterDevices);
    allDevices = (await res.json()).filter(d=>d.CENTRE_ID==centreId);
    const catRes = await fetch(API.devicecategory);
    allCategories = await catRes.json();
    updateSummary();
    showCategoryCards();
  }catch(err){console.error(err);}
}

function clearFilters(){
  document.getElementById("startDateTime").value = "";
  document.getElementById("endDateTime").value = "";
  if(currentCategoryId) openDeviceDashboard(currentCategoryId);
}

// Update summary cards
function updateSummary(){
  const total=allDevices.length;
  const active=allDevices.filter(d=>d.status?.toLowerCase()==="active").length;
  document.getElementById("totalDevices").textContent=total;
  document.getElementById("activeDevices").textContent=active;
  document.getElementById("offlineDevices").textContent=total-active;
}

// Show category cards
function showCategoryCards(){
  document.getElementById("deviceDetailsContainer").style.display="none";
  const container=document.getElementById("deviceTypeCards");
  container.innerHTML="";
  allCategories.forEach(cat=>{
    const devicesOfCat = allDevices.filter(d=>d.CATEGORY_ID===cat.CATEGORY_ID);
    const count = devicesOfCat.length;
    const card = document.createElement("div");
    card.className="device-type-card";
    card.innerHTML=`<h6>${cat.CATEGORY_NAME}</h6><strong>${count}</strong>`;
    if(count>0) card.onclick=()=>openDeviceDashboard(cat.CATEGORY_ID, cat.CATEGORY_NAME);
    else card.classList.add('disabled');
    container.appendChild(card);
  });
}

function backToDashboard(){ showCategoryCards(); if(liveUpdateInterval) clearInterval(liveUpdateInterval);}
function logout(){ fetch('/logout/').then(()=>window.location='/login/');}

// Update graph automatically when date/time changes
document.getElementById("startDateTime").addEventListener("change", ()=>{ if(currentCategoryId) openDeviceDashboard(currentCategoryId); });
document.getElementById("endDateTime").addEventListener("change", ()=>{ if(currentCategoryId) openDeviceDashboard(currentCategoryId); });
document.getElementById("organizationSelect").addEventListener("change",e=>loadCentres(e.target.value));
document.getElementById("centreSelect").addEventListener("change",e=>loadDevices(e.target.value));

// ----- Device Dashboard -----
// ----- Device Dashboard -----
async function openDeviceDashboard(categoryId) {
  currentCategoryId = categoryId;
  document.getElementById("deviceTypeCards").innerHTML = "";
  document.getElementById("deviceDetailsContainer").style.display = "block";

  const category = allCategories.find(c => c.CATEGORY_ID === categoryId);
  document.getElementById("deviceTypeTitle").textContent = category?.CATEGORY_NAME || categoryId;

  const devices = allDevices.filter(d => d.CATEGORY_ID === categoryId);
  const deviceList = document.getElementById("deviceList");
  deviceList.innerHTML = "";

  // Fetch master parameters & UOMs
  const [masterparameter, masteruom] = await Promise.all([
    fetch(API.masterparameter).then(r => r.json()),
    fetch(API.masteruom).then(r => r.json())
  ]);

  // Fetch readings for the category
  let url = API.devicereadinglog + `?centre=${currentCentreId}&category=${currentCategoryId}`;
  const readingsDataRaw = await (await fetch(url)).json();

  // Show each device card with its latest value
  devices.forEach(device => {
    const div = document.createElement("div");
    div.className = "device-card bg-secondary";
    div.style.cursor = "pointer";

    // Latest reading for that device
    // const readings = readingsDataRaw
    //   .filter(r => r.DEVICE_ID === device.DEVICE_ID)
    //   .sort((a, b) => new Date(`${a.READING_DATE}T${a.READING_TIME}`) - new Date(`${b.READING_DATE}T${b.READING_TIME}`));

    const readings = readingsDataRaw
  .filter(r => r.DEVICE_ID === device.DEVICE_ID)
  .filter(r => {
    const param = masterparameter.find(p => p.PARAMETER_ID === r.PARAMETER_ID);
    return param && param.PARAMETER_NAME.toLowerCase().includes("voc");
  })
  .sort((a, b) => new Date(`${a.READING_DATE}T${a.READING_TIME}`) - new Date(`${b.READING_DATE}T${b.READING_TIME}`));


    const latest = readings[readings.length - 1];
    let readingText = "Offline";
    let cardClass = "device-card bg-secondary";

    if (latest) {
      const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(latest.PARAMETER_ID));
      const uomObj = param ? masteruom.find(u => String(u.UOM_ID) === String(param.UOM_ID)) : null;
      const uom = uomObj?.UOM_NAME || '';
      const val = parseFloat(latest.READING).toFixed(2);

      readingText = `${val} ${uom}`;
      const upper = param?.UPPER_THRESHOLD ?? Infinity;
      const lower = param?.LOWER_THRESHOLD ?? -Infinity;
      if (val > upper || val < lower) cardClass = "device-card bg-danger";
      else cardClass = "device-card bg-success";
    }

    div.className = cardClass;
    div.innerHTML = `
      <h6>${device.DEVICE_NAME}</h6>
      <p id="currentTemp_${device.DEVICE_ID}" style="font-weight:600;">${readingText}</p>
    `;

    // Click to view graph & alarms
    div.addEventListener("click", () => loadDeviceReadings(device));

    deviceList.appendChild(div);
  });
}

// Function to load readings, graph, and alarms for a single device
async function loadDeviceReadings(device) {
    const deviceId = device.DEVICE_ID;

    // Fetch master parameters & UOMs
    let masterparameter = [], masteruom = [];
    try {
        masterparameter = await (await fetch(API.masterparameter)).json();
        masteruom = await (await fetch(API.masteruom)).json();
    } catch (err) { console.error(err); }

    // Date range
    const now = new Date();
    let start = new Date(now.getTime() - 24*60*60*1000);
    let end = now;
    const startInput = document.getElementById("startDateTime").value;
    const endInput = document.getElementById("endDateTime").value;
    if (startInput) start = new Date(startInput);
    if (endInput) end = new Date(endInput);

    // Fetch readings
    let url = API.devicereadinglog + `?centre=${currentCentreId}&category=${currentCategoryId}`;
    const readingsDataRaw = await (await fetch(url)).json();
    // const readingsData = readingsDataRaw.filter(r => r.DEVICE_ID === deviceId);
    
    const readingsData = readingsDataRaw
  .filter(r => r.DEVICE_ID === deviceId)
  .filter(r => {
    const param = masterparameter.find(p => p.PARAMETER_ID === r.PARAMETER_ID);
    return param && param.PARAMETER_NAME.toLowerCase().includes("voc");
  });

    // const dataPoints = readingsData.map(r => {
    //     const dt = new Date(r.READING_DATE + "T" + r.READING_TIME);
    //     return { x: dt, y: parseFloat(r.READING), paramId: r.PARAMETER_ID };
    // });

    const dataPoints = readingsData
  .map(r => {
    const dt = new Date(r.READING_DATE + "T" + r.READING_TIME);
    return { x: dt, y: parseFloat(r.READING), paramId: r.PARAMETER_ID };
  })
  .filter(p => {
    const param = masterparameter.find(pp => String(pp.PARAMETER_ID) === String(p.paramId));
    const name = param?.PARAMETER_NAME?.toLowerCase() || "";

    // ✅ Check for parameter types
    const isVOC = name.includes("voc");
    const isRefricheck = name.includes("refricheck");

    // ✅ Apply limits: VOC ≤ 2000, Refricheck ≤ 15
    if (isVOC && p.y <= 2000) return true;
    if (isRefricheck && p.y <= 15) return true;

    return false; // ignore everything else
  });


    // Update device reading text
    const latest = dataPoints[dataPoints.length - 1];
    const param = masterparameter.find(p => String(p.PARAMETER_ID) === String(latest?.paramId));
    const uomObj = param ? masteruom.find(u => String(u.UOM_ID) === String(param.UOM_ID)) : null;
    const uom = uomObj?.UOM_NAME || '';
    const el = document.getElementById(`currentTemp_${deviceId}`);
    if (latest) {
        el.textContent = latest.y.toFixed(2) + " " + uom;
        el.parentElement.className = (latest.y > (param?.UPPER_THRESHOLD ?? Infinity) || latest.y < (param?.LOWER_THRESHOLD ?? -Infinity)) ? "device-card bg-danger" : "device-card bg-success";
    } else {
        el.textContent = "Offline";
        el.parentElement.className = "device-card bg-secondary";
    }

    // Update chart for this device
    const ctx = document.getElementById("deviceGraph").getContext('2d');
    if (window.deviceChart) window.deviceChart.destroy();
    window.deviceChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: device.DEVICE_NAME,
                data: dataPoints,
                borderColor: "#007bff",
                backgroundColor: "#007bff",
                tension: 0.3,
                fill: false,
                pointRadius: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive:true,
            maintainAspectRatio:false,
            plugins: {
                tooltip: { mode:'index', intersect:false },
                legend: { display:true, position:'top' }
            },
            scales: {
                x: { type:'time', time:{ tooltipFormat:'dd-MM-yyyy HH:mm' } },
                y: { beginAtZero:true, title:{ display:true, text:'Reading Value' } }
            }
        }
    });

    // Update alarms for this device
    const alarmUrl = API.devicealarmlog + `?centre=${currentCentreId}&category=${currentCategoryId}`;
    const alarmsRaw = await (await fetch(alarmUrl)).json();
    const alarms = alarmsRaw.filter(a => a.DEVICE_ID === deviceId);
    const alarmBody = document.getElementById("alarmLog"); 
    alarmBody.innerHTML = "";
    let activeCount = 0;
    alarms.forEach(a => {
        const isActive = a.IS_ACTIVE === 1;
        if(isActive) activeCount++;
        alarmBody.innerHTML += `<tr>
            <td>${device.DEVICE_NAME}</td>
            <td>${a.READING ?? '-'}</td>
            <td>${a.ALARM_DATE} ${a.ALARM_TIME}</td>
            <td><span class="badge ${isActive?'bg-danger':'bg-success'}">${isActive?'Active':'Resolved'}</span></td>
        </tr>`;
    });
    document.getElementById("alarm24h").textContent = alarms.filter(a=>now-new Date(a.ALARM_DATE+"T"+a.ALARM_TIME)<=24*60*60*1000).length;
    document.getElementById("activeAlarmCount").textContent = activeCount;

    // Initial update & live interval
    updateDeviceGraph();
    if (liveUpdateInterval) clearInterval(liveUpdateInterval);
    liveUpdateInterval = setInterval(updateDeviceGraph, 10000);
}

// Initialize dashboard
(async function initDashboard() {
  await loadOrganizations();
})();
</script>
</body>
</html>


<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IoT Multi-Level Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
body { margin:0; padding-top:70px; display:flex; }
.navbar { background: linear-gradient(90deg, #0d6efd, #0a58ca); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.navbar .nav-link { color:#fff !important; }
.sidebar { width:260px; background:#f8f9fa; border-right:1px solid #dee2e6; padding:20px; position:fixed; top:70px; bottom:0; display:flex; flex-direction:column; overflow:hidden; }
.sidebar-content { overflow-y:auto; flex:1; padding-right:5px; }
.sidebar h5 { font-weight:600; margin-bottom:15px; }
.sidebar .form-select { margin-bottom:15px; border-radius:8px; }
.sidebar .summary-card { min-height:60px; padding:2px 4px; margin-bottom:10px; font-size:0.8rem; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; color:#fff; }
.sidebar .summary-card i { font-size:1.4rem; margin-bottom:4px; }
.sidebar .summary-card h6 { font-size:0.85rem; margin-bottom:2px; }
.sidebar .summary-card p { font-size:0.9rem; margin:0; font-weight:600; }
.content { margin-left:260px; padding:20px; flex:1; overflow-x:hidden; }
#deviceTypeCards { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-top:50px; }
.device-type-card { flex:1 1 calc(33.33% - 10px); max-width:calc(33.33% - 10px); height:120px; background:linear-gradient(135deg,#0d6efd,#6610f2); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); cursor:pointer; transition:0.3s; }
.device-type-card:hover { transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.2); }
.device-type-card.disabled { background:#e0e0e0 !important; color:#888 !important; cursor:not-allowed; }
.device-center { display:flex; justify-content:center; margin-top:20px; }
.device-card { padding:10px; border-radius:12px; color:white; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-bottom:10px; max-width:300px; width:100%; }
.device-card.bg-success { background:#fff; border:2px solid #28a745; color:#000; min-height:60px; max-width:400px; }
.device-card.bg-danger { background:#fff; border:2px solid #dc3545; color:#000; min-height:60px; max-width:400px; }
#deviceDetailsContainer { display:none; }
#deviceList .device-card { width:100%; margin-bottom:8px; }
#alarmLog tr td { vertical-align:middle; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
<div class="container-fluid">
  <a class="navbar-brand" href="#">IoT Dashboard</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
    </ul>
  </div>
</div>
</nav>

<div class="sidebar">
  <div class="sidebar-content">
    <h5>Filters</h5>
    <select id="organizationSelect" class="form-select mb-3"><option value="">Select Organization</option></select>
    <select id="centreSelect" class="form-select mb-3"><option value="">Select Centre</option></select>

    <label for="startDateTime">Start Date & Time</label>
    <input type="datetime-local" id="startDateTime" class="form-control mb-2">
    <label for="endDateTime">End Date & Time</label>
    <input type="datetime-local" id="endDateTime" class="form-control mb-3">
    <button class="btn btn-primary mb-3" onclick="refreshDeviceDashboard()">Apply Filter</button>

    <h5>Summary</h5>
    <div id="summaryCards">
      <div class="summary-card bg-primary text-center mb-3">
        <i class="bi bi-hdd-network"></i><h6>Total Devices</h6><p id="totalDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-success text-center mb-3">
        <i class="bi bi-check-circle"></i><h6>Active Devices</h6><p id="activeDevices" class="fs-5 fw-bold">0</p>
      </div>
      <div class="summary-card bg-danger text-center mb-3">
        <i class="bi bi-x-circle"></i><h6>Offline Devices</h6><p id="offlineDevices" class="fs-5 fw-bold">0</p>
      </div>
    </div>
  </div>
</div>

<div class="content">
  <div id="deviceTypeCards" class="d-flex flex-wrap gap-3"></div>

  <div id="deviceDetailsContainer">
    <button class="btn btn-sm btn-secondary mb-3" onclick="backToDashboard()">← Back</button>
    <h4 id="deviceTypeTitle"></h4>

    <div id="deviceList" class="mb-3"></div>

    <div style="max-width:700px;margin:auto;display:flex;gap:15px;align-items:flex-start;">
      <div style="flex:0 0 150px;display:flex;flex-direction:column;gap:10px;margin-left:-200px;">
        <div style="background:#0d6efd;color:#fff;border-radius:10px;padding:8px;text-align:center;">
          <h6 style="font-size:0.8rem;margin-bottom:4px;">Current Temp</h6>
          <p id="currentTemp" class="fs-6 fw-bold">0 °C</p>
        </div>
        <div style="background:#dc3545;color:#fff;border-radius:10px;padding:8px;text-align:center;">
          <h6 style="font-size:0.8rem;margin-bottom:4px;">Total Alarms (24h)</h6>
          <p id="alarm24h" class="fs-6 fw-bold">0</p>
        </div>
      </div>
      <div style="flex:1;background:#fff;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);padding:15px;">
        <canvas id="deviceGraph" style="max-height:300px;"></canvas>
      </div>
    </div>

    <h5 class="mt-4 d-flex justify-content-between align-items-center">
      Alarm Log <span class="badge bg-danger" id="activeAlarmCount">0</span>
    </h5>
    <input type="text" id="alarmSearch" class="form-control mb-2" placeholder="Search alarms...">
    <table class="table table-striped">
      <thead><tr><th>Device</th><th>Alarm</th><th>Time</th><th>Status</th></tr></thead>
      <tbody id="alarmLog"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// const BASE_URL = `${window.location.protocol}//${window.location.hostname}:8080`; // Dynamic host/IP
// const BASE_URL = "http://192.168.1.6:8000/api/"; // direct IP
// const BASE_URL = "http://192.168.0.100:8000"; // direct IP
const BASE_URL = "https://iot-y8pi.onrender.com"; // direct IP
// const BASE_URL = "https://16de7fd271a3.ngrok-free.app"; // direct IP
// const BASE_URL = "https://1vs2c96b-8000.inc1.devtunnels.ms"; // direct IP

const API = {
  masterorganizations: BASE_URL + "/api/masterorganization/",
  mastercentre: BASE_URL + "/api/mastercentre/",
  devicecategory: BASE_URL + "/api/devicecategory/",
  masterDevices: BASE_URL + "/api/masterdevice/",
  devicereadinglog: BASE_URL + "/api/devicereadinglog/",
  devicealarmlog: BASE_URL + "/api/devicealarmlog/",
  userorganizationcentrelink: BASE_URL + "/api/userorganizationcentrelink/",
  // masterorganizations: "http://127.0.0.1:8000/api/masterorganization/",
  // mastercentre:        "http://127.0.0.1:8000/api/mastercentre/",
  // masterDevices:       "http://127.0.0.1:8000/api/masterdevice/",
  // devicereadinglog:    "http://127.0.0.1:8000/api/devicereadinglog/",
  // devicealarmlog:      "http://127.0.0.1:8000/api/devicealarmlog/",
  // userorganizationcentrelink: "http://127.0.0.1:8000/api/userorganizationcentrelink/",
  // devicecategory: "http://127.0.0.1:8000/api/devicecategory/"
};

let centreData=[], allDevices=[], allCategories=[], currentCentreId=null, currentUser=null;
let currentCategoryId=null, liveUpdateInterval=null;

async function loadUserOrganizationCentrelink(){
  try{
    const userRes = await fetch(BASE_URL + "/api/currentuser/");
    // const userRes = await fetch("http://127.0.0.1:8000/api/currentuser/");
    currentUser = await userRes.json();
    const res = await fetch(API.userorganizationcentrelink+`?USER_ID=${currentUser.USER_ID}`);
    const linkData = await res.json();
    if(linkData.length>0){
      const orgId = linkData[0].ORGANIZATION_ID;
      const centreId = linkData[0].CENTRE_ID;
      document.getElementById("organizationSelect").value = orgId;
      await loadCentres(orgId);
      document.getElementById("centreSelect").value = centreId;
      loadDevices(centreId);
    }
  }catch(err){ console.error(err);}
}

async function loadOrganizations(){
  try{
   // 1️⃣ Pehle user ka link load karo
    const userRes = await fetch(BASE_URL + "/api/currentuser/");
    const currentUser = await userRes.json();

    const linkRes = await fetch(API.userorganizationcentrelink + `?USER_ID=${currentUser.USER_ID}`);
    const userLinks = await linkRes.json(); // ye array me org+centre links milega

    const allowedOrgIds = userLinks.map(l => l.ORGANIZATION_ID); // allowed org IDs

    // 2️⃣ Fetch all orgs
    const res = await fetch(API.masterorganizations);
    const orgs = await res.json();

    const orgSelect = document.getElementById("organizationSelect");
    orgSelect.innerHTML = '<option value="">Select Organization</option>';

    // 3️⃣ Filter orgs by allowedOrgIds
    orgs
      .filter(o => allowedOrgIds.includes(o.ORGANIZATION_ID))
      .forEach(o => orgSelect.innerHTML += `<option value="${o.ORGANIZATION_ID}">${o.ORGANIZATION_NAME}</option>`);
  }catch(err){ console.error(err);}
}

async function loadCentres(orgId){
  const centreSelect=document.getElementById("centreSelect");
  centreSelect.innerHTML='<option value="">Select Centre</option>';
  if(!orgId) return;
  try{
    if(!centreData.length){
      const res = await fetch(API.mastercentre);
      centreData = await res.json();
    }
    centreData.filter(c=>c.ORGANIZATION_ID==orgId)
      .forEach(c=>centreSelect.innerHTML += `<option value="${c.CENTRE_ID}">${c.CENTRE_NAME}</option>`);
  }catch(err){console.error(err);}
}

async function loadDevices(centreId){
  currentCentreId=centreId;
  try{
    const res = await fetch(API.masterDevices);
    allDevices = (await res.json()).filter(d=>d.CENTRE_ID==centreId);
    const catRes = await fetch(API.devicecategory);
    allCategories = await catRes.json();
    updateSummary();
    showCategoryCards();
  }catch(err){console.error(err);}
}

function updateSummary(){
  const total=allDevices.length;
  const active=allDevices.filter(d=>d.status?.toLowerCase()==="active").length;
  document.getElementById("totalDevices").textContent=total;
  document.getElementById("activeDevices").textContent=active;
  document.getElementById("offlineDevices").textContent=total-active;
}

function showCategoryCards(){
  document.getElementById("deviceDetailsContainer").style.display="none";
  const container=document.getElementById("deviceTypeCards");
  container.innerHTML="";
  allCategories.forEach(cat=>{
    const devicesOfCat = allDevices.filter(d=>d.CATEGORY_ID===cat.CATEGORY_ID);
    const count = devicesOfCat.length;
    const card = document.createElement("div");
    card.className="device-type-card";
    card.innerHTML=`<h6>${cat.CATEGORY_NAME}</h6><strong>${count}</strong>`;
    if(count>0) card.onclick=()=>openDeviceDashboard(cat.CATEGORY_ID, cat.CATEGORY_NAME);
    else card.classList.add('disabled');
    container.appendChild(card);
  });
}

function backToDashboard(){ showCategoryCards(); if(liveUpdateInterval) clearInterval(liveUpdateInterval);}
document.getElementById("organizationSelect").addEventListener("change",e=>loadCentres(e.target.value));
document.getElementById("centreSelect").addEventListener("change",e=>loadDevices(e.target.value));
function logout(){ fetch('/logout/').then(()=>window.location='/login/');}
function refreshDeviceDashboard(){ if(currentCategoryId) openDeviceDashboard(currentCategoryId); }

// ----- Device Dashboard with 10-min interval + multiple days + date-time filter -----
async function openDeviceDashboard(categoryId){
  currentCategoryId=categoryId;
  document.getElementById("deviceTypeCards").innerHTML="";
  document.getElementById("deviceDetailsContainer").style.display="block";
  const category = allCategories.find(c=>c.CATEGORY_ID===categoryId);
  document.getElementById("deviceTypeTitle").textContent=category?.CATEGORY_NAME||categoryId;

  const devices = allDevices.filter(d=>d.CATEGORY_ID===categoryId);
  const deviceList=document.getElementById("deviceList");
  deviceList.innerHTML="";
  devices.forEach(d=>{
    const temp = parseFloat(d.reading||0).toFixed(2);
    const color = temp>70?'bg-danger':'bg-success';
    const div=document.createElement("div");
    div.className="device-card "+color;
    div.innerHTML=`<h6>${d.DEVICE_NAME}</h6><p>${temp} °C</p>`;
    deviceList.appendChild(div);
  });

  async function updateDeviceGraph(){
    try{
      const start = document.getElementById("startDateTime").value ? new Date(document.getElementById("startDateTime").value) : null;
      const end = document.getElementById("endDateTime").value ? new Date(document.getElementById("endDateTime").value) : null;

      let url = API.devicereadinglog+`?centre=${currentCentreId}&category=${currentCategoryId}`;
      const readingsDataRaw = await (await fetch(url)).json();
      const readingsData = readingsDataRaw.filter(r=>{
        const dt=new Date(r.READING_DATE+"T"+r.READING_TIME);
        return devices.map(d=>d.DEVICE_ID).includes(r.DEVICE_ID) && (!start || dt>=start) && (!end || dt<=end);
      });

      const deviceMap={}; devices.forEach(d=>deviceMap[d.DEVICE_ID]=[]);
      readingsData.forEach(r=>{
        let dt=new Date(r.READING_DATE+"T"+r.READING_TIME);
        dt.setMinutes(Math.floor(dt.getMinutes()/10)*10,0,0);
        deviceMap[r.DEVICE_ID].push({x:dt,y:parseFloat(r.READING)});
      });

      // Fill missing intervals
      if(start && end){
        devices.forEach(d=>{
          let current=new Date(start);
          while(current<=end){
            if(!deviceMap[d.DEVICE_ID].some(r=>r.x.getTime()===current.getTime())){
              deviceMap[d.DEVICE_ID].push({x:new Date(current),y:null});
            }
            current=new Date(current.getTime()+10*60*1000);
          }
          deviceMap[d.DEVICE_ID].sort((a,b)=>a.x-b.x);
        });
      }

      const ctx=document.getElementById("deviceGraph").getContext('2d');
      const datasets=devices.map(d=>{
        const grad=ctx.createLinearGradient(0,0,700,0); grad.addColorStop(0,"#42a5f5"); grad.addColorStop(1,"#66bb6a");
        return {label:d.DEVICE_NAME,data:deviceMap[d.DEVICE_ID],borderColor:grad,backgroundColor:"rgba(66,165,245,0.2)",fill:true,tension:0.3,pointRadius:4,pointHoverRadius:6,borderWidth:2};
      });

      if(window.deviceChart){ window.deviceChart.data.datasets=datasets; window.deviceChart.update(); }
      else{
        window.deviceChart=new Chart(ctx,{type:'line',data:{datasets},options:{
          responsive:true,maintainAspectRatio:false,interaction:{mode:'nearest',intersect:false},
          plugins:{legend:{display:true,position:'top'},tooltip:{mode:'index',intersect:false,callbacks:{label:c=>c.dataset.label+": "+(c.parsed.y!=null?c.parsed.y.toFixed(2)+" °C":"-")}}},
          scales:{x:{type:'time',time:{tooltipFormat:'dd-MM-yyyy HH:mm',displayFormats:{hour:'dd MMM HH:mm',minute:'HH:mm'}},title:{display:true,text:'Date & Time',font:{size:14,weight:'bold'}},ticks:{autoSkip:true,maxRotation:45,minRotation:30}},y:{beginAtZero:true,suggestedMin:0,suggestedMax:100,title:{display:true,text:'Temperature (°C)',font:{size:14,weight:'bold'}},ticks:{stepSize:5}}}
        }});
      }

      document.getElementById("currentTemp").textContent = readingsData.length ? parseFloat(readingsData.at(-1).READING).toFixed(2)+" °C" : "0 °C";

      // Alarms
      let alarmUrl = API.devicealarmlog+`?centre=${currentCentreId}&category=${currentCategoryId}`;
      const alarmsRaw = await (await fetch(alarmUrl)).json();
      const alarms = alarmsRaw.filter(a=>{
        const dt=new Date(a.ALARM_DATE+"T"+a.ALARM_TIME);
        return devices.map(d=>d.DEVICE_ID).includes(a.DEVICE_ID) && (!start || dt>=start) && (!end || dt<=end);
      });

      const now=new Date();
      document.getElementById("alarm24h").textContent = alarms.filter(a=>now-new Date(a.ALARM_DATE+"T"+a.ALARM_TIME)<=24*60*60*1000).length;

      // 🔹 Sort alarms by date & time descending
    alarms.sort((a,b)=>{
    const dateA = new Date(a.ALARM_DATE+"T"+a.ALARM_TIME);
    const dateB = new Date(b.ALARM_DATE+"T"+b.ALARM_TIME);
    return dateB - dateA; // latest first
     });

      const alarmBody=document.getElementById("alarmLog"); alarmBody.innerHTML=""; let activeCount=0;
      alarms.forEach(a=>{
        const device=devices.find(d=>d.DEVICE_ID===a.DEVICE_ID); if(!device)return;
        const isActive=a.IS_ACTIVE===1; if(isActive) activeCount++;
        alarmBody.innerHTML+=`<tr><td>${device.DEVICE_NAME}</td><td>${a.READING??'-'}</td><td>${a.ALARM_DATE} ${a.ALARM_TIME}</td><td><span class="badge ${isActive?'bg-danger':'bg-success'}">${isActive?'Active':'Resolved'}</span></td></tr>`;
      });
      document.getElementById("activeAlarmCount").textContent=activeCount;

    }catch(err){console.error("Graph/Alarm update error:",err);}
  }

  updateDeviceGraph();
  if(liveUpdateInterval) clearInterval(liveUpdateInterval);
  liveUpdateInterval=setInterval(updateDeviceGraph,5000);
}

// loadOrganizations();
// loadUserOrganizationCentrelink();
(async function initDashboard() {
  await loadOrganizations();              // pehle org dropdown fill ho jaye
  await loadUserOrganizationCentrelink(); // fir user ka org/centre auto select ho
})();
</script>

</body>
</html> -->
